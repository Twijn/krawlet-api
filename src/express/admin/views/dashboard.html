<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Krawlet Admin Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="/admin/static/dashboard.css" />
  </head>
  <body>
    <div id="loginScreen" class="login-container">
      <h1>üîê Admin Login</h1>
      <p>Enter the admin password to access the dashboard</p>
      <input type="password" id="passwordInput" placeholder="Admin Password" />
      <button onclick="login()">Login</button>
      <div id="loginError" class="error" style="display: none; margin-top: 15px"></div>
    </div>

    <div id="dashboard" style="display: none">
      <div class="container">
        <header>
          <div>
            <h1>üìä Krawlet Admin Dashboard</h1>
            <p class="subtitle">API Key Usage & Analytics</p>
          </div>
          <div class="header-actions">
            <button onclick="showCreateKeyModal()">+ Create API Key</button>
            <button class="secondary" onclick="logout()">Logout</button>
          </div>
        </header>

        <div id="errorContainer"></div>
        <div id="successContainer"></div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total API Keys</div>
            <div class="stat-value" id="totalKeys">-</div>
            <div class="stat-subvalue"><span id="activeKeys">-</span> active</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Requests</div>
            <div class="stat-value" id="totalRequests">-</div>
            <div class="stat-subvalue">Last 24h: <span id="requests24h">-</span></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Blocked Requests</div>
            <div class="stat-value" id="blockedRequests">-</div>
            <div class="stat-subvalue"><span id="blockRate">-</span>% block rate</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Most Active Key</div>
            <div class="stat-value" style="font-size: 18px" id="mostActiveKey">-</div>
            <div class="stat-subvalue"><span id="mostActiveCount">-</span> requests</div>
          </div>
        </div>

        <div class="charts-grid">
          <div class="section">
            <h2>üìà Request Trends (7 Days)</h2>
            <div class="chart-container">
              <canvas id="trendsChart"></canvas>
            </div>
          </div>
          <div class="section">
            <h2>üéØ Requests by Tier</h2>
            <div class="chart-container">
              <canvas id="tierChart"></canvas>
            </div>
          </div>
        </div>

        <div class="charts-grid">
          <div class="section" style="grid-column: span 2">
            <h2>üõ§Ô∏è Top Endpoints (7 Days)</h2>
            <div class="chart-container" style="height: 300px">
              <canvas id="pathsChart"></canvas>
            </div>
          </div>
        </div>

        <div class="charts-grid">
          <div class="section">
            <h2>üåê Requests by IP (7 Days)</h2>
            <div class="chart-container" style="height: 300px">
              <canvas id="ipsChart"></canvas>
            </div>
          </div>
          <div class="section">
            <h2>üìä IP Details</h2>
            <div id="ipPathBreakdown" style="padding: 20px; color: #8899a6; text-align: center">
              Click on an IP in the chart to see details
            </div>
          </div>
        </div>

        <div class="charts-grid">
          <div class="section" style="grid-column: span 2">
            <h2>ü§ñ Requests by User Agent (7 Days)</h2>
            <div class="chart-container" style="height: 300px">
              <canvas id="userAgentsChart"></canvas>
            </div>
          </div>
        </div>

        <div class="charts-grid">
          <div class="section" style="grid-column: span 2">
            <h2>üîó Top Referers (7 Days)</h2>
            <div class="chart-container" style="height: 300px">
              <canvas id="referersChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Blocked IPs Section -->
        <div class="section blocked-section">
          <div class="section-header">
            <h2>üõ°Ô∏è IP Blocking & Abuse Protection</h2>
            <div class="filters">
              <button onclick="showBlockIpModal()">+ Block IP</button>
              <button class="secondary" onclick="loadBlockedIps()">Refresh</button>
            </div>
          </div>

          <!-- Blocked Stats -->
          <div class="blocked-stats-grid">
            <div class="blocked-stat-card">
              <div class="stat-label">App-Level Blocks</div>
              <div class="stat-value" id="activeAppBlocks">-</div>
              <div class="stat-subvalue">Temporary blocks</div>
            </div>
            <div class="blocked-stat-card firewall">
              <div class="stat-label">Firewall Blocks</div>
              <div class="stat-value" id="activeFirewallBlocks">-</div>
              <div class="stat-subvalue">For UFW blocking</div>
            </div>
            <div class="blocked-stat-card">
              <div class="stat-label">Blocked Requests (24h)</div>
              <div class="stat-value" id="blockedRequests24h">-</div>
              <div class="stat-subvalue">Prevented access</div>
            </div>
            <div class="blocked-stat-card">
              <div class="stat-label">Tracked IPs</div>
              <div class="stat-value" id="trackedIps">-</div>
              <div class="stat-subvalue">In abuse detection</div>
            </div>
          </div>

          <!-- Tabs for different views -->
          <div class="blocked-tabs">
            <button class="tab-btn active" onclick="switchBlockedTab('all')">All Blocks</button>
            <button class="tab-btn" onclick="switchBlockedTab('firewall')">üî• Firewall List</button>
            <button class="tab-btn" onclick="switchBlockedTab('config')">‚öôÔ∏è Config</button>
          </div>

          <!-- All Blocks Tab -->
          <div id="blockedAllTab" class="blocked-tab-content">
            <div class="filters" style="margin-bottom: 15px">
              <select id="blockLevelFilter" onchange="loadBlockedIps()">
                <option value="">All Levels</option>
                <option value="app">App-Level Only</option>
                <option value="firewall">Firewall Only</option>
              </select>
              <select id="blockActiveFilter" onchange="loadBlockedIps()">
                <option value="true">Active Only</option>
                <option value="">All (Including Expired)</option>
                <option value="false">Expired/Removed Only</option>
              </select>
            </div>
            <div id="blockedTable" class="loading">Loading...</div>
            <div id="blockedPagination" class="pagination"></div>
          </div>

          <!-- Firewall List Tab -->
          <div id="blockedFirewallTab" class="blocked-tab-content" style="display: none">
            <div class="firewall-info">
              <p>
                ‚ö†Ô∏è These IPs should be blocked at the firewall level using UFW. Copy commands below:
              </p>
            </div>
            <div id="firewallCommands" class="loading">Loading...</div>
          </div>

          <!-- Config Tab -->
          <div id="blockedConfigTab" class="blocked-tab-content" style="display: none">
            <div class="config-grid">
              <div class="config-item">
                <label>Max Consecutive 429s</label>
                <input type="number" id="configMax429s" min="1" max="100" />
                <span class="config-help">Block after N consecutive rate limit responses</span>
              </div>
              <div class="config-item">
                <label>Burst Threshold (req/sec)</label>
                <input type="number" id="configBurstThreshold" min="1" max="100" />
                <span class="config-help">Block if requests exceed this per second</span>
              </div>
              <div class="config-item">
                <label>Sustained Traffic Threshold</label>
                <input type="number" id="configSustainedThreshold" min="1" max="200" />
                <span class="config-help">Block after N requests at rate limit in 5 min</span>
              </div>
              <div class="config-item">
                <label>User Agent Cycling Threshold</label>
                <input type="number" id="configUaThreshold" min="2" max="20" />
                <span class="config-help">Block after N different user agents in 10 min</span>
              </div>
              <div class="config-item">
                <label>Initial Block Duration (min)</label>
                <input type="number" id="configInitialDuration" min="1" max="1440" />
                <span class="config-help">First-time offense block duration</span>
              </div>
              <div class="config-item">
                <label>Repeat Block Duration (min)</label>
                <input type="number" id="configRepeatDuration" min="1" max="1440" />
                <span class="config-help">Repeat offender block duration</span>
              </div>
              <div class="config-item">
                <label>Escalation After N Blocks</label>
                <input type="number" id="configEscalationCount" min="1" max="10" />
                <span class="config-help">Escalate to firewall after this many app blocks</span>
              </div>
            </div>
            <div style="margin-top: 15px">
              <button onclick="saveBlockConfig()">Save Configuration</button>
              <span class="config-note"
                >Note: Changes are runtime only and will reset on server restart</span
              >
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2>üîë API Keys</h2>
            <div class="filters">
              <select id="tierFilter" onchange="loadKeys()">
                <option value="">All Tiers</option>
                <option value="free">Free</option>
                <option value="premium">Premium</option>
              </select>
              <select id="activeFilter" onchange="loadKeys()">
                <option value="">All Status</option>
                <option value="true">Active</option>
                <option value="false">Inactive</option>
              </select>
              <input
                type="text"
                id="searchKeys"
                placeholder="Search by name or email..."
                onkeyup="loadKeys()"
              />
              <button onclick="exportKeys()">üì• Export CSV</button>
            </div>
          </div>
          <div id="keysTable" class="loading">Loading...</div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2>üìù Recent Request Logs</h2>
            <div class="filters">
              <select id="statusFilter" onchange="loadLogs()">
                <option value="">All Requests</option>
                <option value="success">Success Only</option>
                <option value="blocked">Blocked Only</option>
              </select>
              <input
                type="text"
                id="searchLogs"
                placeholder="Search by IP or path..."
                onkeyup="loadLogs()"
              />
              <button onclick="loadLogs()">Refresh</button>
              <button onclick="exportLogs()">üì• Export CSV</button>
            </div>
          </div>
          <div id="logsTable" class="loading">Loading...</div>
          <div id="logsPagination" class="pagination"></div>
        </div>
      </div>
    </div>

    <!-- Key Details Modal -->
    <div id="keyModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>API Key Details</h3>
          <button class="close-modal" onclick="closeModal('keyModal')">&times;</button>
        </div>
        <div id="keyDetails"></div>
      </div>
    </div>

    <!-- Create Key Modal -->
    <div id="createKeyModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Create New API Key</h3>
          <button class="close-modal" onclick="closeModal('createKeyModal')">&times;</button>
        </div>
        <div>
          <div style="margin-bottom: 15px">
            <label style="display: block; color: #8899a6; margin-bottom: 5px">Name</label>
            <input type="text" id="createKeyName" placeholder="Key name" style="width: 100%" />
          </div>
          <div style="margin-bottom: 15px">
            <label style="display: block; color: #8899a6; margin-bottom: 5px"
              >Email (optional)</label
            >
            <input
              type="email"
              id="createKeyEmail"
              placeholder="user@example.com"
              style="width: 100%"
            />
          </div>
          <div style="margin-bottom: 15px">
            <label style="display: block; color: #8899a6; margin-bottom: 5px">Tier</label>
            <select id="createKeyTier" style="width: 100%">
              <option value="free">Free</option>
              <option value="premium">Premium</option>
            </select>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 20px">
            <button onclick="createKey()" style="flex: 1">Create Key</button>
            <button class="secondary" onclick="closeModal('createKeyModal')" style="flex: 1">
              Cancel
            </button>
          </div>
          <div id="createKeyResult" style="margin-top: 15px"></div>
        </div>
      </div>
    </div>

    <!-- Edit Key Modal -->
    <div id="editKeyModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Edit API Key</h3>
          <button class="close-modal" onclick="closeModal('editKeyModal')">&times;</button>
        </div>
        <div>
          <div style="margin-bottom: 15px">
            <label style="display: block; color: #8899a6; margin-bottom: 5px">Name</label>
            <input type="text" id="editKeyName" placeholder="Key name" style="width: 100%" />
          </div>
          <div style="margin-bottom: 15px">
            <label style="display: block; color: #8899a6; margin-bottom: 5px"
              >Email (optional)</label
            >
            <input
              type="email"
              id="editKeyEmail"
              placeholder="user@example.com"
              style="width: 100%"
            />
          </div>
          <div style="margin-bottom: 15px">
            <label style="display: block; color: #8899a6; margin-bottom: 5px">Tier</label>
            <select id="editKeyTier" style="width: 100%">
              <option value="free">Free</option>
              <option value="premium">Premium</option>
            </select>
          </div>
          <div style="margin-bottom: 15px">
            <label style="display: block; color: #8899a6; margin-bottom: 5px"
              >Rate Limit (requests/hour)</label
            >
            <input
              type="number"
              id="editKeyRateLimit"
              placeholder="1000"
              style="width: 100%"
              min="0"
            />
          </div>
          <div style="margin-bottom: 15px">
            <label style="display: block; color: #8899a6; margin-bottom: 5px">Request Count</label>
            <input
              type="number"
              id="editKeyRequestCount"
              placeholder="0"
              style="width: 100%"
              min="0"
            />
          </div>
          <div style="display: flex; gap: 10px; margin-top: 20px">
            <button onclick="saveKeyEdits()" style="flex: 1">Save Changes</button>
            <button class="secondary" onclick="closeModal('editKeyModal')" style="flex: 1">
              Cancel
            </button>
          </div>
          <div id="editKeyResult" style="margin-top: 15px"></div>
        </div>
      </div>
    </div>

    <!-- Log Details Modal -->
    <div id="logDetailsModal" class="modal">
      <div class="modal-content" style="max-width: 700px">
        <div class="modal-header">
          <h3>Request Log Details</h3>
          <button class="close-modal" onclick="closeModal('logDetailsModal')">&times;</button>
        </div>
        <div id="logDetailsContent"></div>
      </div>
    </div>

    <!-- Block IP Modal -->
    <div id="blockIpModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Block IP Address</h3>
          <button class="close-modal" onclick="closeModal('blockIpModal')">&times;</button>
        </div>
        <div>
          <div style="margin-bottom: 15px">
            <label style="display: block; color: #8899a6; margin-bottom: 5px">IP Address</label>
            <input
              type="text"
              id="blockIpAddress"
              placeholder="192.168.1.100"
              style="width: 100%"
            />
          </div>
          <div style="margin-bottom: 15px">
            <label style="display: block; color: #8899a6; margin-bottom: 5px">Block Level</label>
            <select id="blockIpLevel" style="width: 100%">
              <option value="app">App-Level (temporary, auto-expires)</option>
              <option value="firewall">Firewall (for UFW blocking, no expiry)</option>
            </select>
          </div>
          <div style="margin-bottom: 15px">
            <label style="display: block; color: #8899a6; margin-bottom: 5px">Reason</label>
            <input
              type="text"
              id="blockIpReason"
              placeholder="Manual block - suspicious activity"
              style="width: 100%"
            />
          </div>
          <div style="margin-bottom: 15px" id="blockDurationContainer">
            <label style="display: block; color: #8899a6; margin-bottom: 5px"
              >Duration (minutes)</label
            >
            <input
              type="number"
              id="blockIpDuration"
              placeholder="60"
              min="1"
              max="10080"
              style="width: 100%"
              value="60"
            />
            <span class="config-help">Leave empty for default (60 min for app-level)</span>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 20px">
            <button onclick="blockIp()" style="flex: 1">Block IP</button>
            <button class="secondary" onclick="closeModal('blockIpModal')" style="flex: 1">
              Cancel
            </button>
          </div>
          <div id="blockIpResult" style="margin-top: 15px"></div>
        </div>
      </div>
    </div>

    <!-- Block Details Modal -->
    <div id="blockDetailsModal" class="modal">
      <div class="modal-content" style="max-width: 600px">
        <div class="modal-header">
          <h3>Block Details</h3>
          <button class="close-modal" onclick="closeModal('blockDetailsModal')">&times;</button>
        </div>
        <div id="blockDetailsContent"></div>
      </div>
    </div>

    <script src="/admin/static/dashboard.js"></script>
  </body>
</html>
